@using KNQASelfService.Models
@using MudBlazor

<MudDialog MaxWidth="MaxWidth.Medium" FullWidth="true">
    <DialogContent>
        <MudGrid>
            <!-- Header Section -->
            <MudItem xs="12">
                <MudPaper Class="pa-4 mb-4"
                          Style="background: linear-gradient(135deg, #00286E 0%, #003d8f 100%); border-radius: 8px;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <MudIcon Icon="@Icons.Material.Filled.Description"
                                     Size="Size.Large"
                                     Style="color:#D4A853;" />
                            <div>
                                <MudText Typo="Typo.h5" Style="color:white;font-weight:600;">
                                    Leave Application Details
                                </MudText>
                                <MudText Typo="Typo.body2" Style="color:rgba(255,255,255,0.8);">
                                    Application #@LeaveApplication?.ApplicationNo
                                </MudText>
                            </div>
                        </MudStack>

                        @if (LeaveApplication != null)
                        {
                            <MudChip T="string"
                                     Color="@GetColor(LeaveApplication.Status)"
                                     Size="Size.Small"
                                     Style="font-weight:600;">
                                @LeaveApplication.Status
                            </MudChip>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>

            @if (LeaveApplication != null)
            {
                <!-- Leave Info -->
                <MudItem xs="12">
                    <MudPaper Class="pa-4 mb-4"
                              Elevation="1"
                              Style="border-radius:8px;border-left:4px solid #00286E;">
                        <MudText Typo="Typo.h6" Style="color:#00286E;margin-bottom:16px;">
                            <MudIcon Icon="@Icons.Material.Filled.Event" Class="mr-2" />
                            Leave Information
                        </MudText>

                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudText Typo="Typo.subtitle2">Leave Type</MudText>
                                <MudChip T="string" Style="background:#D4A853;color:white;">
                                    @LeaveApplication.LeaveCode
                                </MudChip>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudText Typo="Typo.subtitle2">Days Applied</MudText>
                                <MudChip T="string" Style="background:#00286E;color:white;">
                                    @LeaveApplication.DaysApplied days
                                </MudChip>
                            </MudItem>

                            <MudItem xs="12" sm="4">
                                <MudText Typo="Typo.subtitle2">Start Date</MudText>
                                <MudText>
                                    @ParseDate(LeaveApplication.StartDate)
                                </MudText>
                            </MudItem>

                            <MudItem xs="12" sm="4">
                                <MudText Typo="Typo.subtitle2">End Date</MudText>
                                <MudText>
                                    @ParseDate(LeaveApplication.EndDate)
                                </MudText>
                            </MudItem>

                            <MudItem xs="12" sm="4">
                                <MudText Typo="Typo.subtitle2">Return Date</MudText>
                                <MudText>
                                    @ParseDate(LeaveApplication.ResumptionDate)
                                </MudText>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>

                <!-- Employee Info -->
                <MudItem xs="12">
                    <MudPaper Class="pa-4 mb-4"
                              Elevation="1"
                              Style="border-radius:8px;border-left:4px solid #D4A853;">
                        <MudText Typo="Typo.h6" Style="color:#00286E;margin-bottom:16px;">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" />
                            Employee Information
                        </MudText>

                        <MudText Typo="Typo.body1"><b>Employee No:</b> @LeaveApplication.EmployeeNo</MudText>
                        <MudText Typo="Typo.body1"><b>Application Date:</b> @ParseDate(LeaveApplication.ApplicationDate)</MudText>
                        <MudText Typo="Typo.body1">
                            <b>Duties Taken Over By:</b> @GetEmployeeDisplayName()
                        </MudText>
                    </MudPaper>
                </MudItem>

                <!-- Leave Balance -->
                <MudItem xs="12">
                    <MudPaper Class="pa-4"
                              Elevation="1"
                              Style="border-radius:8px;border-left:4px solid #f44336;">
                        <MudText Typo="Typo.h6" Style="color:#00286E;margin-bottom:16px;">
                            Leave Balance
                        </MudText>

                        <MudGrid>
                            <MudItem xs="4">
                                <MudText Typo="Typo.subtitle2"><b>Entitlement</b></MudText>
                                <MudText Typo="Typo.h6" Style="color:#00286E;">@LeaveApplication.LeaveEntitlement days</MudText>
                            </MudItem>

                            <MudItem xs="4">
                                <MudText Typo="Typo.subtitle2"><b>Taken</b></MudText>
                                <MudText Typo="Typo.h6" Style="color:#f44336;">
                                    @Math.Abs(LeaveApplication.TotalLeaveDaysTaken) days
                                </MudText>
                            </MudItem>

                            <MudItem xs="4">
                                <MudText Typo="Typo.subtitle2"><b>Remaining</b></MudText>
                                <MudText Typo="Typo.h6" Style="@GetBalanceStyle(LeaveApplication.LeaveBalance)">
                                    @LeaveApplication.LeaveBalance days
                                </MudText>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>

                <!-- Additional Info (if exists) -->
                @if (!string.IsNullOrEmpty(LeaveApplication.Reason))
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-4 mb-4"
                                  Elevation="1"
                                  Style="border-radius:8px;border-left:4px solid #4caf50;">
                            <MudText Typo="Typo.h6" Style="color:#00286E;margin-bottom:16px;">
                                Additional Information
                            </MudText>
                            <MudText Typo="Typo.body1"><b>Reason:</b> @LeaveApplication.Reason</MudText>
                        </MudPaper>
                    </MudItem>
                }
            }
            else
            {
                <MudItem xs="12">
                    <div style="text-align: center; padding: 60px 20px;">
                        <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Large" Style="font-size: 4rem; opacity: 0.3; color: #00286E;" />
                        <MudText Typo="Typo.h6" Style="margin-top: 16px; color: #999;">No leave application data available</MudText>
                        <MudText Typo="Typo.body2" Style="color: #999;">Please select a valid leave application</MudText>
                    </div>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>

   
</MudDialog>

@code {
    [CascadingParameter]
    private Microsoft.AspNetCore.Components.CascadingValue<object>? CascadingDialog { get; set; }

    [Parameter]
    public LeaveApplication? LeaveApplication { get; set; }

    private void CloseDialog()
    {
        // The dialog will close when shown with proper options
        // The Close button in the top-right (from DialogOptions) will work
    }

    private string GetEmployeeDisplayName()
    {
        if (!string.IsNullOrWhiteSpace(LeaveApplication?.Name))
            return $"{LeaveApplication.Name}";

        if (!string.IsNullOrWhiteSpace(LeaveApplication?.DutiesTakenOverBy))
            return $"{LeaveApplication.DutiesTakenOverBy}";

        return "Not assigned";
    }

    private Color GetColor(string status) => status switch
    {
        "Open" => Color.Default,
        "Pending Approval" => Color.Warning,
        "Approved" => Color.Success,
        "Rejected" => Color.Error,
        _ => Color.Info
    };

    private string GetBalanceStyle(int balance) =>
        balance > 10 ? "color:#4caf50;font-weight:700;" :
        balance > 5 ? "color:#D4A853;font-weight:700;" :
                       "color:#f44336;font-weight:700;";

    private string ParseDate(string dateStr)
    {
        if (string.IsNullOrEmpty(dateStr) || dateStr == "0001-01-01")
            return "Not specified";

        return DateTime.TryParse(dateStr, out var d)
            ? d.ToString("dd MMM yyyy")
            : dateStr;
    }
}