@using KNQASelfService.Models
@using MudBlazor
@inject IAppraisalService AppraisalService
@inject IPerformanceTargetService PerformanceTargetService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDialog MaxWidth="MaxWidth.ExtraLarge" FullWidth="true">
    <DialogContent>
        @if (Appraisal != null)
        {
            <MudGrid Spacing="3">
                <!-- Header -->
                <MudItem xs="12">
                    <MudText Typo="Typo.h5" Style="color: #00286E; font-weight: 600;">
                        <MudIcon Icon="@Icons.Material.Filled.Assessment" Style="margin-right: 8px;" />
                        @(IsEditing ? "Edit Appraisal" : "View Appraisal"): @Appraisal.AppraisalNo
                    </MudText>
                    <div style="display: flex; align-items: center; gap: 16px; margin-top: 8px;">
                        <MudChip T="string" Size="Size.Small" Style="@GetStatusStyle(Appraisal.Status)">
                            @Appraisal.StatusDisplay
                        </MudChip>
                        <MudText Typo="Typo.caption" Style="color: #666;">
                            Created: @Appraisal.CreatedDate.ToString("dd/MM/yyyy HH:mm")
                        </MudText>
                        @if (Appraisal.SubmittedDate.HasValue)
                        {
                            <MudText Typo="Typo.caption" Style="color: #666;">
                                Submitted: @Appraisal.SubmittedDate?.ToString("dd/MM/yyyy HH:mm")
                            </MudText>
                        }
                    </div>
                </MudItem>

                <!-- Appraisal Information -->
                <MudItem xs="12">
                    <MudPaper Elevation="1" Class="pa-3" Style="background-color: #f8f9fa; border-radius: 8px;">
                        <MudGrid Spacing="2">
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="Appraisal.AppraisalPeriod"
                                              Label="Appraisal Period"
                                              Variant="Variant.Outlined"
                                              ReadOnly="!IsEditing" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudSelect T="string"
                                           @bind-Value="Appraisal.AppraisalType"
                                           Label="Appraisal Type"
                                           Variant="Variant.Outlined"
                                           ReadOnly="!IsEditing">
                                    @foreach (var type in appraisalTypes)
                                    {
                                        <MudSelectItem T="string" Value="@type">@type</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="Appraisal.PerformanceEvaluation"
                                              Label="Performance Evaluation"
                                              Variant="Variant.Outlined"
                                              ReadOnly="true" />
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>

                <!-- Employee and Appraiser Details -->
                <MudItem xs="12">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            <MudPaper Elevation="1" Class="pa-3" Style="background-color: #e8f5e9; border-radius: 8px;">
                                <MudText Typo="Typo.subtitle2" Style="color:#00286E;font-weight:600;margin-bottom: 8px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Style="margin-right: 8px;" />
                                    Appraisee Details
                                </MudText>
                                <MudGrid Spacing="2">
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Employee</MudText>
                                        <MudText Typo="Typo.body2">@Appraisal.AppraiseeName (@Appraisal.EmployeeNo)</MudText>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Job Title</MudText>
                                        <MudText Typo="Typo.body2">@Appraisal.AppraiseeJobTitle</MudText>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Department</MudText>
                                        <MudText Typo="Typo.body2">@Appraisal.DepartmentName (@Appraisal.DepartmentCode)</MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudPaper Elevation="1" Class="pa-3" Style="background-color: #fff8e1; border-radius: 8px;">
                                <MudText Typo="Typo.subtitle2" Style="color:#00286E;font-weight:600;margin-bottom: 8px;">
                                    <MudIcon Icon="@Icons.Material.Filled.SupervisorAccount" Size="Size.Small" Style="margin-right: 8px;" />
                                    Appraiser Details
                                </MudText>
                                <MudGrid Spacing="2">
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Appraiser</MudText>
                                        <MudText Typo="Typo.body2">@Appraisal.AppraiserName (@Appraisal.AppraiserNo)</MudText>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Job Title</MudText>
                                        <MudText Typo="Typo.body2">@Appraisal.AppraiserJobTitle</MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudItem>

                <!-- Linked Performance Target -->
                @if (Appraisal.LinkedPerformanceTarget != null)
                {
                    <MudItem xs="12">
                        <MudPaper Elevation="1" Class="pa-3" Style="background-color: #e3f2fd; border-radius: 8px; border-left: 4px solid #1976d2;">
                            <MudGrid Spacing="2" AlignItems="AlignItems.Center">
                                <MudItem xs="12" md="8">
                                    <MudText Typo="Typo.subtitle2" Style="color:#00286E;font-weight:600;">
                                        <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Style="margin-right: 8px;" />
                                        Linked Performance Target
                                    </MudText>
                                    <MudText Typo="Typo.body2">
                                        @Appraisal.LinkedPerformanceTarget.ObjectiveNo - 
                                        @Appraisal.LinkedPerformanceTarget.AppraisalPeriod
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="color: #666;">
                                        @Appraisal.LinkedPerformanceTarget.TargetLines.Count target lines • 
                                        Status: @Appraisal.LinkedPerformanceTarget.Status
                                    </MudText>
                                </MudItem>
                                <MudItem xs="12" md="4" Style="text-align: right;">
                                    <MudButton Variant="Variant.Outlined"
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Visibility"
                                               OnClick="ViewPerformanceTarget">
                                        View Target
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    </MudItem>
                }

                <!-- Appraisal Lines - Self Assessment -->
                <MudItem xs="12">
                    <MudPaper Elevation="1" Class="pa-3" Style="background-color: #f3e5f5; border-radius: 8px;">
                        <MudText Typo="Typo.subtitle2" Style="color:#00286E;font-weight:600;margin-bottom: 16px;">
                            <MudIcon Icon="@Icons.Material.Filled.Score" Size="Size.Small" Style="margin-right: 8px;" />
                            Performance Assessment
                        </MudText>
                        
                        @if (Appraisal.AppraisalLines.Any())
                        {
                            <!-- Scoring Instructions -->
                            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mb-3">
                                <MudAlertTitle>Self-Assessment Guidelines</MudAlertTitle>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li>Rate your performance on each KPI (0-100%)</li>
                                    <li>Provide progress assessment remarks for each item</li>
                                    <li>Total weighted score will be calculated automatically</li>
                                    <li>Once submitted, you cannot make changes</li>
                                </ul>
                            </MudAlert>

                            <!-- Appraisal Lines Table -->
                            <MudTable Items="@Appraisal.AppraisalLines" Hover="true" Dense="true" Class="mb-4">
                                <HeaderContent>
                                    <MudTh>Key Performance Area</MudTh>
                                    <MudTh>Key Performance Indicator</MudTh>
                                    <MudTh>Performance Measure</MudTh>
                                    <MudTh>Target</MudTh>
                                    <MudTh>Weighting %</MudTh>
                                    @if (IsEditing && Appraisal.Status == AppraisalStatus.OPEN)
                                    {
                                        <MudTh>Your Score (0-100%)</MudTh>
                                        <MudTh>Progress Remarks</MudTh>
                                    }
                                    else
                                    {
                                        <MudTh>Employee Score</MudTh>
                                        <MudTh>Supervisor Score</MudTh>
                                        <MudTh>Agreed Score</MudTh>
                                    }
                                </HeaderContent>
                                <RowTemplate Context="line">
                                    <MudTd>
                                        <MudText Typo="Typo.body2">@line.KeyPerformanceArea</MudText>
                                    </MudTd>
                                    <MudTd>
                                        <MudText Typo="Typo.body2">@line.KeyPerformanceIndicator</MudText>
                                    </MudTd>
                                    <MudTd>
                                        <MudText Typo="Typo.body2">@line.PerformanceMeasure</MudText>
                                    </MudTd>
                                    <MudTd>
                                        <MudText Typo="Typo.body2">@line.Target</MudText>
                                    </MudTd>
                                    <MudTd>
                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@line.MaximumWeighting%</MudText>
                                    </MudTd>
                                    
                                    @if (IsEditing && Appraisal.Status == AppraisalStatus.OPEN)
                                    {
                                        <MudTd>
                                            <MudNumericField T="decimal"
                                                             @bind-Value="line.EmployeeScore"
                                                             Variant="Variant.Outlined"
                                                             Min="0"
                                                             Max="100"
                                                             Step="5"
                                                             Immediate="true"
                                                             OnBlur="@(() => CalculateScores())">
                                                <Adornment>%</Adornment>
                                            </MudNumericField>
                                        </MudTd>
                                        <MudTd>
                                            <MudTextField @bind-Value="line.EmployeeRemarks"
                                                          Variant="Variant.Outlined"
                                                          Lines="1"
                                                          MultiLine="true"
                                                          Immediate="true"
                                                          Placeholder="Progress assessment..." />
                                        </MudTd>
                                    }
                                    else
                                    {
                                        <MudTd>
                                            <div style="text-align: center;">
                                                <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1976d2;">
                                                    @line.EmployeeScore%
                                                </MudText>
                                                <MudText Typo="Typo.caption" Style="color: #666;">
                                                    @line.EmployeeWeightedScore.ToString("0.0")
                                                </MudText>
                                            </div>
                                        </MudTd>
                                        <MudTd>
                                            @if (line.SupervisorScore > 0)
                                            {
                                                <div style="text-align: center;">
                                                    <MudText Typo="Typo.body2" Style="font-weight: 600; color: #9c27b0;">
                                                        @line.SupervisorScore%
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Style="color: #666;">
                                                        @line.SupervisorWeightedScore.ToString("0.0")
                                                    </MudText>
                                                </div>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.caption" Style="color: #999; text-align: center;">
                                                    Pending
                                                </MudText>
                                            }
                                        </MudTd>
                                        <MudTd>
                                            @if (line.AgreedScore > 0)
                                            {
                                                <div style="text-align: center;">
                                                    <MudText Typo="Typo.body2" Style="font-weight: 600; color: #4caf50;">
                                                        @line.AgreedScore%
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Style="color: #666;">
                                                        @line.AgreedWeightedScore.ToString("0.0")
                                                    </MudText>
                                                </div>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.caption" Style="color: #999; text-align: center;">
                                                    Pending
                                                </MudText>
                                            }
                                        </MudTd>
                                    }
                                </RowTemplate>
                                <FooterContent>
                                    <MudTd ColSpan="4">
                                        <MudText Typo="Typo.body2" Style="text-align: right; font-weight: 600;">
                                            Total:
                                        </MudText>
                                    </MudTd>
                                    <MudTd>
                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                            @Appraisal.TotalMaximumScore%
                                        </MudText>
                                    </MudTd>
                                    @if (IsEditing && Appraisal.Status == AppraisalStatus.OPEN)
                                    {
                                        <MudTd>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1976d2;">
                                                @totalEmployeeScore.ToString("0.0")%
                                            </MudText>
                                        </MudTd>
                                        <MudTd></MudTd>
                                    }
                                    else
                                    {
                                        <MudTd>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1976d2;">
                                                @Appraisal.TotalScoreEmployee.ToString("0.0")
                                            </MudText>
                                        </MudTd>
                                        <MudTd>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: #9c27b0;">
                                                @Appraisal.TotalScoreSupervisor.ToString("0.0")
                                            </MudText>
                                        </MudTd>
                                        <MudTd>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: #4caf50;">
                                                @Appraisal.TotalScoreAgreed.ToString("0.0")
                                            </MudText>
                                        </MudTd>
                                    }
                                </FooterContent>
                            </MudTable>

                            <!-- Score Summary -->
                            <MudGrid Spacing="2" Class="mt-4">
                                <MudItem xs="12" md="4">
                                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: #e3f2fd; border-radius: 4px;">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Employee Score</MudText>
                                        <MudText Typo="Typo.h5" Style="color: #1976d2; font-weight: 600;">
                                            @(IsEditing && Appraisal.Status == AppraisalStatus.OPEN ? totalEmployeeScore.ToString("0.0") : Appraisal.TotalScoreEmployee.ToString("0.0"))
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #666;">
                                            @(IsEditing && Appraisal.Status == AppraisalStatus.OPEN ? 
                                              $"Weighted: {(totalEmployeeScore/Appraisal.TotalMaximumScore*100):0.0}%" : 
                                              $"Weighted: {(Appraisal.TotalScoreEmployee/Appraisal.TotalMaximumScore*100):0.0}%")
                                        </MudText>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: #f3e5f5; border-radius: 4px;">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Supervisor Score</MudText>
                                        <MudText Typo="Typo.h5" Style="color: #9c27b0; font-weight: 600;">
                                            @Appraisal.TotalScoreSupervisor.ToString("0.0")
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #666;">
                                            Weighted: @((Appraisal.TotalScoreSupervisor/Appraisal.TotalMaximumScore*100).ToString("0.0"))%
                                        </MudText>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: #e8f5e9; border-radius: 4px;">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Overall Rating</MudText>
                                        <MudText Typo="Typo.h5" Style="color: #4caf50; font-weight: 600;">
                                            @(Appraisal.OverallRating?.ToString("0.0") ?? "0.0")%
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #666;">
                                            Category: @Appraisal.PerformanceCategory
                                        </MudText>
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>
                        }
                        else
                        {
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Large" Style="margin-bottom: 16px;" />
                                <MudText Typo="Typo.h6">No assessment lines found</MudText>
                                <MudText Typo="Typo.body2">This appraisal needs to be linked to a performance target first.</MudText>
                            </div>
                        }
                    </MudPaper>
                </MudItem>

                <!-- Comments Section -->
                <MudItem xs="12">
                    <MudPaper Elevation="1" Class="pa-3" Style="background-color: #fff8e1; border-radius: 8px;">
                        <MudText Typo="Typo.subtitle2" Style="color:#00286E;font-weight:600;margin-bottom: 16px;">
                            <MudIcon Icon="@Icons.Material.Filled.Comment" Size="Size.Small" Style="margin-right: 8px;" />
                            Comments
                        </MudText>
                        
                        <MudGrid Spacing="3">
                            @if (IsEditing && Appraisal.Status == AppraisalStatus.OPEN)
                            {
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="employeeComments"
                                                  Label="Your Comments"
                                                  Variant="Variant.Outlined"
                                                  Lines="3"
                                                  MultiLine="true"
                                                  Placeholder="Add your comments about this appraisal..." />
                                </MudItem>
                            }
                            else
                            {
                                @if (!string.IsNullOrEmpty(Appraisal.EmployeeComments))
                                {
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Employee Comments:</MudText>
                                        <MudText Typo="Typo.body2">@Appraisal.EmployeeComments</MudText>
                                    </MudItem>
                                }
                                
                                @if (!string.IsNullOrEmpty(Appraisal.AppraiserComments))
                                {
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Supervisor Comments:</MudText>
                                        <MudText Typo="Typo.body2">@Appraisal.AppraiserComments</MudText>
                                    </MudItem>
                                }
                                
                                @if (!string.IsNullOrEmpty(Appraisal.AgreedComments))
                                {
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Agreed Comments:</MudText>
                                        <MudText Typo="Typo.body2">@Appraisal.AgreedComments</MudText>
                                    </MudItem>
                                }
                            }
                        </MudGrid>
                    </MudPaper>
                </MudItem>

                <!-- Action History -->
                @if (!IsEditing || Appraisal.Status != AppraisalStatus.OPEN)
                {
                    <MudItem xs="12">
                        <MudPaper Elevation="1" Class="pa-3" Style="background-color: #f8f9fa; border-radius: 8px;">
                            <MudText Typo="Typo.subtitle2" Style="color:#00286E;font-weight:600;margin-bottom: 16px;">
                                <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" Style="margin-right: 8px;" />
                                Action History
                            </MudText>
                            
                            <MudTimeline Position="TimelinePosition.Alternate">
                                <MudTimelineItem Color="Color.Info">
                                    <MudTimelineItemOppositeContent>
                                        @Appraisal.CreatedDate.ToString("dd/MM/yyyy HH:mm")
                                    </MudTimelineItemOppositeContent>
                                    <MudTimelineItemContent>
                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">Appraisal Created</MudText>
                                        <MudText Typo="Typo.caption">Appraisal document created</MudText>
                                    </MudTimelineItemContent>
                                </MudTimelineItem>
                                
                                @if (Appraisal.SubmittedDate.HasValue)
                                {
                                    <MudTimelineItem Color="Color.Primary">
                                        <MudTimelineItemOppositeContent>
                                            @Appraisal.SubmittedDate?.ToString("dd/MM/yyyy HH:mm")
                                        </MudTimelineItemOppositeContent>
                                        <MudTimelineItemContent>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">Submitted for Assessment</MudText>
                                            <MudText Typo="Typo.caption">Employee submitted self-assessment</MudText>
                                        </MudTimelineItemContent>
                                    </MudTimelineItem>
                                }
                                
                                @if (Appraisal.AppraisedDate.HasValue)
                                {
                                    <MudTimelineItem Color="Color.Secondary">
                                        <MudTimelineItemOppositeContent>
                                            @Appraisal.AppraisedDate?.ToString("dd/MM/yyyy HH:mm")
                                        </MudTimelineItemOppositeContent>
                                        <MudTimelineItemContent>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">Appraised by Supervisor</MudText>
                                            <MudText Typo="Typo.caption">Supervisor completed assessment</MudText>
                                        </MudTimelineItemContent>
                                    </MudTimelineItem>
                                }
                                
                                @if (Appraisal.AgreedDate.HasValue)
                                {
                                    <MudTimelineItem Color="Color.Success">
                                        <MudTimelineItemOppositeContent>
                                            @Appraisal.AgreedDate?.ToString("dd/MM/yyyy HH:mm")
                                        </MudTimelineItemOppositeContent>
                                        <MudTimelineItemContent>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">Agreement Reached</MudText>
                                            <MudText Typo="Typo.caption">Employee and supervisor agreed on scores</MudText>
                                        </MudTimelineItemContent>
                                    </MudTimelineItem>
                                }
                                
                                @if (Appraisal.CompletedDate.HasValue)
                                {
                                    <MudTimelineItem Color="Color.Success">
                                        <MudTimelineItemOppositeContent>
                                            @Appraisal.CompletedDate?.ToString("dd/MM/yyyy HH:mm")
                                        </MudTimelineItemOppositeContent>
                                        <MudTimelineItemContent>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">Appraisal Completed</MudText>
                                            <MudText Typo="Typo.caption">Appraisal process finalized</MudText>
                                        </MudTimelineItemContent>
                                    </MudTimelineItem>
                                }
                            </MudTimeline>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <div style="text-align: center; padding: 40px;">
                <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Style="font-size: 4rem; color: #f44336;" />
                <MudText Typo="Typo.h6" Style="margin-top: 16px; color: #999;">No appraisal information available</MudText>
            </div>
        }
    </DialogContent>
    <DialogActions>
        @if (Appraisal != null)
        {
            <MudButton OnClick="Cancel">Cancel</MudButton>
            
            @if (IsEditing && Appraisal.Status == AppraisalStatus.OPEN && Appraisal.EmployeeNo == CurrentEmployeeNo)
            {
                <MudButton Variant="Variant.Filled"
                           Style="background-color: #1976d2; color: white;"
                           OnClick="SaveDraft"
                           Disabled="@saving">
                    @if (saving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Style="color: white;" />
                        <span class="ms-2">Saving...</span>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Save" Size="Size.Small" />
                        <span class="ms-2">Save Draft</span>
                    }
                </MudButton>
                
                <MudButton Variant="Variant.Filled"
                           Style="background-color: #4caf50; color: white;"
                           OnClick="SubmitForAssessment"
                           Disabled="@saving">
                    <MudIcon Icon="@Icons.Material.Filled.Send" Size="Size.Small" />
                    <span class="ms-2">Submit for Assessment</span>
                </MudButton>
            }
            else if (Appraisal.Status == AppraisalStatus.SUBMITTED && Appraisal.AppraiserNo == CurrentEmployeeNo)
            {
                <MudButton Variant="Variant.Filled"
                           Style="background-color: #9c27b0; color: white;"
                           OnClick="StartAppraisal"
                           Disabled="@saving">
                    <MudIcon Icon="@Icons.Material.Filled.RateReview" Size="Size.Small" />
                    <span class="ms-2">Start Appraisal</span>
                </MudButton>
            }
            else if (Appraisal.Status == AppraisalStatus.APPRAISED && Appraisal.EmployeeNo == CurrentEmployeeNo)
            {
                <MudButton Variant="Variant.Filled"
                           Style="background-color: #4caf50; color: white;"
                           OnClick="StartAgreement"
                           Disabled="@saving">
                    <MudIcon Icon="@Icons.Material.Filled.Handshake" Size="Size.Small" />
                    <span class="ms-2">Start Agreement</span>
                </MudButton>
            }
            else if (Appraisal.Status == AppraisalStatus.AGREED && Appraisal.AppraiserNo == CurrentEmployeeNo)
            {
                <MudButton Variant="Variant.Filled"
                           Style="background-color: #2e7d32; color: white;"
                           OnClick="CompleteAppraisal"
                           Disabled="@saving">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                    <span class="ms-2">Complete Appraisal</span>
                </MudButton>
            }
            
            @if (Appraisal.CanEdit && Appraisal.EmployeeNo == CurrentEmployeeNo)
            {
                <MudButton Variant="Variant.Outlined"
                           Style="border-color: #f44336; color: #f44336;"
                           OnClick="ConfirmDelete">
                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                    <span class="ms-2">Delete</span>
                </MudButton>
            }
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private Microsoft.AspNetCore.Components.CascadingValue<object>? CascadingDialog { get; set; }

    [Parameter] public Appraisal? Appraisal { get; set; }
    [Parameter] public string CurrentEmployeeNo { get; set; } = string.Empty;

    private bool saving = false;
    private bool IsEditing => Appraisal?.CanEdit == true && Appraisal.EmployeeNo == CurrentEmployeeNo;
    private List<string> appraisalTypes = new();
    private string employeeComments = string.Empty;
    private decimal totalEmployeeScore = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            appraisalTypes = await AppraisalService.GetAppraisalTypesAsync();
            
            if (Appraisal != null)
            {
                employeeComments = Appraisal.EmployeeComments;
                CalculateScores();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading dialog: {ex.Message}", Severity.Error);
        }
    }

    private string GetStatusStyle(string status)
    {
        return status switch
        {
            AppraisalStatus.OPEN => "background-color: #ff9800; color: white;",
            AppraisalStatus.IN_PROGRESS => "background-color: #ffb74d; color: white;",
            AppraisalStatus.SUBMITTED => "background-color: #1976d2; color: white;",
            AppraisalStatus.APPRAISED => "background-color: #9c27b0; color: white;",
            AppraisalStatus.AGREED => "background-color: #4caf50; color: white;",
            AppraisalStatus.COMPLETED => "background-color: #2e7d32; color: white;",
            _ => "background-color: #999; color: white;"
        };
    }

    private void CalculateScores()
    {
        if (Appraisal == null || Appraisal.AppraisalLines == null)
            return;

        totalEmployeeScore = Appraisal.AppraisalLines.Sum(l => l.EmployeeWeightedScore);
        Appraisal.TotalScoreEmployee = totalEmployeeScore;
    }

    private async Task SaveDraft()
    {
        try
        {
            saving = true;
            StateHasChanged();

            // Update employee comments
            if (Appraisal != null)
            {
                Appraisal.EmployeeComments = employeeComments;
                
                // Save the appraisal
                var result = await AppraisalService.UpdateAppraisalAsync(Appraisal);
                
                if (result.StartsWith("Success"))
                {
                    Snackbar.Add("Appraisal saved as draft successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add(result, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving draft: {ex.Message}", Severity.Error);
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private async Task SubmitForAssessment()
    {
        try
        {
            var confirmed = await DialogService.ShowMessageBox(
                "Submit for Assessment",
                "Are you sure you want to submit this appraisal for assessment? Once submitted, you cannot make changes.",
                yesText: "Submit",
                cancelText: "Cancel");

            if (confirmed == true)
            {
                saving = true;
                StateHasChanged();

                var result = await AppraisalService.SubmitAppraisalAsync(Appraisal?.AppraisalNo ?? "", employeeComments);
                
                if (result.StartsWith("Success"))
                {
                    Snackbar.Add("Appraisal submitted for assessment successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add(result, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error submitting for assessment: {ex.Message}", Severity.Error);
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private async Task StartAppraisal()
    {
        try
        {
            var confirmed = await DialogService.ShowMessageBox(
                "Start Appraisal",
                "Are you ready to start the appraisal process? This will allow you to review and score the employee's self-assessment.",
                yesText: "Start",
                cancelText: "Cancel");

            if (confirmed == true)
            {
                saving = true;
                StateHasChanged();

                var result = await AppraisalService.StartAppraisalAsync(Appraisal?.AppraisalNo ?? "");
                
                if (result.StartsWith("Success"))
                {
                    Snackbar.Add("Appraisal started successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add(result, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error starting appraisal: {ex.Message}", Severity.Error);
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private async Task StartAgreement()
    {
        try
        {
            var confirmed = await DialogService.ShowMessageBox(
                "Start Agreement Process",
                "Are you ready to review the supervisor's assessment and reach an agreement?",
                yesText: "Start",
                cancelText: "Cancel");

            if (confirmed == true)
            {
                saving = true;
                StateHasChanged();

                var result = await AppraisalService.StartAgreementAsync(Appraisal?.AppraisalNo ?? "");
                
                if (result.StartsWith("Success"))
                {
                    Snackbar.Add("Agreement process started successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add(result, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error starting agreement: {ex.Message}", Severity.Error);
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private async Task CompleteAppraisal()
    {
        try
        {
            var confirmed = await DialogService.ShowMessageBox(
                "Complete Appraisal",
                "Are you sure you want to complete this appraisal? This will finalize the appraisal process.",
                yesText: "Complete",
                cancelText: "Cancel");

            if (confirmed == true)
            {
                saving = true;
                StateHasChanged();

                var result = await AppraisalService.CompleteAppraisalAsync(Appraisal?.AppraisalNo ?? "");
                
                if (result.StartsWith("Success"))
                {
                    Snackbar.Add("Appraisal completed successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add(result, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error completing appraisal: {ex.Message}", Severity.Error);
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private async Task ViewPerformanceTarget()
    {
        if (Appraisal?.LinkedPerformanceTarget != null)
        {
            var parameters = new DialogParameters
        {
            { "Target", Appraisal.LinkedPerformanceTarget }
        };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Large,
                FullWidth = true,
                CloseButton = true
            };

            await DialogService.ShowAsync<PerformanceTargetViewDialog>("View Performance Target", parameters, options);
        }
    }

    private async Task ConfirmDelete()
    {
        try
        {
            var confirmed = await DialogService.ShowMessageBox(
                "Delete Appraisal",
                $"Are you sure you want to delete appraisal '{Appraisal?.AppraisalNo}'? This action cannot be undone.",
                yesText: "Delete",
                cancelText: "Cancel");

            if (confirmed == true)
            {
                var result = await AppraisalService.DeleteAppraisalAsync(Appraisal?.AppraisalNo ?? "");
                
                if (result.StartsWith("Success"))
                {
                    Snackbar.Add($"Appraisal {Appraisal?.AppraisalNo} deleted successfully", Severity.Success);
                }
                else
                {
                    Snackbar.Add(result, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting appraisal: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
      
    }
}