@using KNQASelfService.Models
@using MudBlazor
@using Microsoft.AspNetCore.Components

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h5" Style="color: #00286E; margin-bottom: 20px;">
            <MudIcon Icon="@Icons.Material.Filled.Handshake" Style="margin-right: 10px;" />
            Agree on Appraisal
        </MudText>

        @if (Appraisal != null)
        {
            <!-- Appraisal Header -->
            <MudPaper Elevation="0" Class="mb-4 pa-4" Style="background-color: #f5f5f5; border-radius: 8px;">
                <MudGrid Spacing="3">
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body2" Style="color: #666;">Appraisal Number:</MudText>
                        <MudText Typo="Typo.body1" Style="font-weight: 600;">@Appraisal.AppraisalNo</MudText>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.body2" Style="color: #666;">Period:</MudText>
                        <MudText Typo="Typo.body1">@Appraisal.AppraisalPeriod</MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2" Style="color: #666;">Employee:</MudText>
                        <MudText Typo="Typo.body1">@Appraisal.AppraiseeName (@Appraisal.EmployeeNo)</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <!-- Score Comparison -->
            <MudPaper Elevation="1" Class="mb-4 pa-4">
                <MudText Typo="Typo.h6" Class="mb-3" Style="color: #00286E;">Score Comparison</MudText>
                <MudGrid Spacing="3">
                    <MudItem xs="12" md="4">
                        <MudCard Style="background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%); color: white;">
                            <MudCardContent>
                                <MudText Typo="Typo.body2">Your Self-Assessment</MudText>
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@Appraisal.TotalScoreEmployee.ToString("0.0")</MudText>
                                <MudText Typo="Typo.caption">out of @Appraisal.TotalMaximumScore</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCard Style="background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%); color: white;">
                            <MudCardContent>
                                <MudText Typo="Typo.body2">Supervisor Assessment</MudText>
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@Appraisal.TotalScoreSupervisor.ToString("0.0")</MudText>
                                <MudText Typo="Typo.caption">out of @Appraisal.TotalMaximumScore</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCard Style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); color: white;">
                            <MudCardContent>
                                <MudText Typo="Typo.body2">Agreed Score</MudText>
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@Appraisal.TotalScoreAgreed.ToString("0.0")</MudText>
                                <MudText Typo="Typo.caption">out of @Appraisal.TotalMaximumScore</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <!-- Comments Comparison -->
            <MudPaper Elevation="1" Class="mb-4 pa-4">
                <MudText Typo="Typo.h6" Class="mb-3" Style="color: #00286E;">Comments Comparison</MudText>
                <MudGrid Spacing="3">
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #1976d2;">Your Comments</MudText>
                        <MudPaper Elevation="0" Class="pa-3" Style="background-color: #e3f2fd; min-height: 150px;">
                            @if (!string.IsNullOrEmpty(Appraisal.EmployeeComments))
                            {
                                <MudText Typo="Typo.body2">@Appraisal.EmployeeComments</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Style="color: #999;">No comments provided</MudText>
                            }
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #9c27b0;">Supervisor Comments</MudText>
                        <MudPaper Elevation="0" Class="pa-3" Style="background-color: #f3e5f5; min-height: 150px;">
                            @if (!string.IsNullOrEmpty(Appraisal.AppraiserComments))
                            {
                                <MudText Typo="Typo.body2">@Appraisal.AppraiserComments</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Style="color: #999;">No comments provided</MudText>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <!-- Agreement Section -->
            <MudPaper Elevation="1" Class="mb-4 pa-4">
                <MudText Typo="Typo.h6" Class="mb-3" Style="color: #00286E;">Agreement Details</MudText>
                
                <!-- Agreed Comments -->
                <MudItem xs="12" Class="mb-4">
                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #4caf50;">Final Agreed Comments</MudText>
                    <MudTextField @bind-Value="agreedComments"
                                 Label="Enter your agreed comments"
                                 Variant="Variant.Outlined"
                                 Lines="3"
                                 FullWidth="true" />
                </MudItem>

            <!-- Confirm Agreement -->
<MudItem xs="12">
    <MudCheckbox @bind="isAgreed" Color="Color.Success">
        I have reviewed the appraisal scores and comments, and I agree with the assessment
    </MudCheckbox>
</MudItem>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-3">
                        @errorMessage
                    </MudAlert>
                }
            </MudPaper>

            <!-- KPI Details (Optional) -->
            @if (Appraisal.AppraisalLines != null && Appraisal.AppraisalLines.Any())
            {
                <MudPaper Elevation="1" Class="mb-4 pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3" Style="color: #00286E;">KPI Assessment Details</MudText>
                    <MudTable Items="@Appraisal.AppraisalLines" Hover="true" Dense="true">
                        <HeaderContent>
                            <MudTh>KPI</MudTh>
                            <MudTh>Your Score</MudTh>
                            <MudTh>Supervisor Score</MudTh>
                            <MudTh>Agreed Score</MudTh>
                            <MudTh>Status</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="line">
                            <MudTd>
                                <MudText Typo="Typo.body2">@line.KeyPerformanceIndicator</MudText>
                                <MudText Typo="Typo.caption" Style="color: #666;">@line.KeyPerformanceArea</MudText>
                            </MudTd>
                            <MudTd>@line.EmployeeScore.ToString("0.0")</MudTd>
                            <MudTd>@line.SupervisorScore.ToString("0.0")</MudTd>
                            <MudTd>@line.AgreedScore.ToString("0.0")</MudTd>
                            <MudTd>
                                @if (line.HasDisagreement)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning">Needs Review</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Agreed</MudChip>
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            }
        }
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="SubmitAgreement" 
                   Variant="Variant.Filled" 
                   Color="Color.Success"
                   Disabled="@(!isAgreed || string.IsNullOrEmpty(agreedComments))"
                   EndIcon="@Icons.Material.Filled.Handshake">
            @if (submitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                <span class="ms-2">Submitting...</span>
            }
            else
            {
                <span>Agree & Submit</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private Microsoft.AspNetCore.Components.CascadingValue<object>? CascadingDialog { get; set; }

    [Parameter]
    public Appraisal Appraisal { get; set; } = null!;
    
    [Parameter]
    public string CurrentEmployeeNo { get; set; } = string.Empty;
    
    [Inject]
    private IAppraisalService AppraisalService { get; set; } = null!;
    
    private string agreedComments = string.Empty;
    private bool isAgreed = false;
    private bool submitting = false;
    private string? errorMessage;

    protected override void OnInitialized()
    {
        // Initialize agreed comments if already exists
        if (!string.IsNullOrEmpty(Appraisal.AgreedComments))
        {
            agreedComments = Appraisal.AgreedComments;
        }
        
        // Set agreed score if not already set
        if (Appraisal.TotalScoreAgreed == 0 && Appraisal.TotalScoreSupervisor > 0)
        {
            // Default to supervisor score
            Appraisal.TotalScoreAgreed = Appraisal.TotalScoreSupervisor;
        }
    }

    private async Task SubmitAgreement()
    {
        try
        {
            submitting = true;
            errorMessage = null;
            StateHasChanged();

            // Validate
            if (!isAgreed)
            {
                errorMessage = "Please confirm that you agree with the assessment";
                return;
            }

            if (string.IsNullOrEmpty(agreedComments))
            {
                errorMessage = "Please provide agreed comments";
                return;
            }

            // Check if user is authorized to agree
            if (Appraisal.EmployeeNo != CurrentEmployeeNo)
            {
                errorMessage = "Only the employee can agree to this appraisal";
                return;
            }

            // Prepare agreed lines (copy supervisor scores as agreed scores)
            var agreedLines = new List<AppraisalLine>();
            if (Appraisal.AppraisalLines != null)
            {
                foreach (var line in Appraisal.AppraisalLines)
                {
                    var agreedLine = new AppraisalLine
                    {
                        LineNo = line.LineNo,
                        AgreedScore = line.SupervisorScore, // Use supervisor score as agreed score
                        AgreedRemarks = line.SupervisorRemarks
                    };
                    agreedLines.Add(agreedLine);
                }
            }

            // Submit agreement
            var result = await AppraisalService.AgreeOnAppraisalAsync(
                Appraisal.AppraisalNo,
                agreedLines,
                agreedComments);

            if (result.StartsWith("Success"))
            {
                Snackbar.Add("Appraisal agreement submitted successfully!", Severity.Success);
            }
            else
            {
                errorMessage = result;
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error submitting agreement: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            submitting = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
      
    }
}